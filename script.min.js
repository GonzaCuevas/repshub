const header=document.getElementById('header');const mobileMenuToggle=document.getElementById('mobileMenuToggle');const nav=document.getElementById('nav');const navList=document.querySelector('.nav-list');const filterButtons=document.querySelectorAll('.filter-btn');function throttle(func,limit){let inThrottle;return function(...args){if(!inThrottle){func.apply(this,args);inThrottle=true;setTimeout(()=>inThrottle=false,limit)}}}function debounce(func,wait){let timeout;return function executedFunction(...args){const later=()=>{clearTimeout(timeout);func(...args)};clearTimeout(timeout);timeout=setTimeout(later,wait)}}let lastScroll=0;let ticking=false;let rafId=null;function updateHeader(){const currentScroll=window.pageYOffset||window.scrollY;if(currentScroll<lastScroll||currentScroll<50){if(header){header.style.transform='translate3d(0,0,0)';header.style.opacity='1'}}else{if(header&&currentScroll>50){header.style.transform='translate3d(0,-100%,0)';header.style.opacity='0'}}if(currentScroll>50){header?.classList.add('scrolled')}else{header?.classList.remove('scrolled')}if(window.innerWidth<=767&&header&&isMenuOpen){const headerHeight=header.offsetHeight;document.documentElement.style.setProperty('--header-height',`${headerHeight}px`)}lastScroll=currentScroll;ticking=false;rafId=null}function handleScroll(){if(!ticking){rafId=requestAnimationFrame(updateHeader);ticking=true}}window.addEventListener('scroll',handleScroll,{passive:true});window.addEventListener('beforeunload',()=>{if(rafId){cancelAnimationFrame(rafId)}window.removeEventListener('scroll',handleScroll)});if(mobileMenuToggle){let isMenuOpen=false;function updateMobileMenuPosition(){if(window.innerWidth<=767&&header&&navList){const headerRect=header.getBoundingClientRect();const headerHeight=headerRect.height;const headerTop=headerRect.top;document.documentElement.style.setProperty('--header-height',`${headerHeight}px`);if(isMenuOpen&&navList.classList.contains('active')){const menuTop=headerTop+headerHeight;navList.style.top=`${menuTop}px`;navList.style.height=`calc(100vh-${menuTop}px)`}}}if(document.readyState==='loading'){document.addEventListener('DOMContentLoaded',updateMobileMenuPosition)}else{updateMobileMenuPosition()}window.addEventListener('resize',throttle(updateMobileMenuPosition,100));const handleMenuScroll=throttle(()=>{if(window.innerWidth<=767&&isMenuOpen&&navList?.classList.contains('active')){requestAnimationFrame(updateMobileMenuPosition)}},100);window.addEventListener('scroll',handleMenuScroll,{passive:true});mobileMenuToggle.addEventListener('click',()=>{updateMobileMenuPosition();const wasOpen=navList.classList.contains('active');navList.classList.toggle('active');mobileMenuToggle.classList.toggle('active');isMenuOpen=!wasOpen;if(isMenuOpen){document.body.style.overflow='hidden';setTimeout(()=>updateMobileMenuPosition(),10)}else{document.body.style.overflow=''}const spans=mobileMenuToggle.querySelectorAll('span');if(navList.classList.contains('active')){spans[0].style.transform='rotate(45deg)translate(5px,5px)';spans[1].style.opacity='0';spans[2].style.transform='rotate(-45deg)translate(7px,-6px)'}else{spans[0].style.transform='none';spans[1].style.opacity='1';spans[2].style.transform='none'}});document.addEventListener('click',(e)=>{if(window.innerWidth<=767&&isMenuOpen&&navList.classList.contains('active')){const isClickInsideMenu=navList.contains(e.target);const isClickOnToggle=mobileMenuToggle.contains(e.target);if(!isClickInsideMenu&&!isClickOnToggle){navList.classList.remove('active');mobileMenuToggle.classList.remove('active');isMenuOpen=false;document.body.style.overflow='';const spans=mobileMenuToggle.querySelectorAll('span');spans[0].style.transform='none';spans[1].style.opacity='1';spans[2].style.transform='none'}}});const navLinks=document.querySelectorAll('.nav-link');navLinks.forEach(link=>{link.addEventListener('click',()=>{navList.classList.remove('active');mobileMenuToggle.classList.remove('active');isMenuOpen=false;document.body.style.overflow='';const spans=mobileMenuToggle.querySelectorAll('span');spans[0].style.transform='none';spans[1].style.opacity='1';spans[2].style.transform='none'})});document.addEventListener('click',(e)=>{if(!nav.contains(e.target)&&navList.classList.contains('active')){navList.classList.remove('active');mobileMenuToggle.classList.remove('active');const spans=mobileMenuToggle.querySelectorAll('span');spans[0].style.transform='none';spans[1].style.opacity='1';spans[2].style.transform='none'}})}document.querySelectorAll('a[href^="#"]').forEach(anchor=>{anchor.addEventListener('click',function(e){const href=this.getAttribute('href');if(href==='#'||this.hasAttribute('data-agent-link')){return}const target=document.querySelector(href);if(target){e.preventDefault();const headerOffset=80;const elementPosition=target.getBoundingClientRect().top;const offsetPosition=elementPosition+window.pageYOffset-headerOffset;window.scrollTo({top:offsetPosition,behavior:'smooth'})}})});const observerOptions={threshold:0.1,rootMargin:'0px 0px-50px 0px'};const observer=new IntersectionObserver((entries)=>{entries.forEach(entry=>{if(entry.isIntersecting){entry.target.classList.add('visible');observer.unobserve(entry.target)}})},observerOptions);function initScrollAnimations(){const slideUpElements=document.querySelectorAll('.slide-up:not(.observed)');slideUpElements.forEach(el=>{observer.observe(el);el.classList.add('observed')})}document.addEventListener('DOMContentLoaded',()=>{initScrollAnimations()});if(filterButtons.length>0){filterButtons.forEach(button=>{button.addEventListener('click',()=>{filterButtons.forEach(btn=>btn.classList.remove('active'));button.classList.add('active');button.style.transform='scale(0.95)';setTimeout(()=>{button.style.transform='scale(1)'},150)})})}document.addEventListener('DOMContentLoaded',()=>{const categoryButtons=document.querySelectorAll('.category-btn');if(categoryButtons.length>0){categoryButtons.forEach(button=>{if(!button.dataset.listenerAdded){button.dataset.listenerAdded='true';button.addEventListener('click',()=>{categoryButtons.forEach(btn=>btn.classList.remove('active'));button.classList.add('active');setTimeout(()=>{const filters=buildFiltersFromUI();loadProductsPage(1,filters)},10)})}})}const searchInput=document.getElementById('productSearch');if(searchInput){const handleSearch=debounce((e)=>{const searchTerm=e.target.value.trim();const filters=buildFiltersFromUI();if(searchTerm){filters.search=searchTerm}loadProductsPage(1,filters)},400);searchInput.addEventListener('input',handleSearch,{passive:true})}const sortSelect=document.getElementById('sortSelect');if(sortSelect){sortSelect.addEventListener('change',function(){const selectedValue=this.value;const filters=buildFiltersFromUI();filters.sort=selectedValue;currentPage=1;loadProductsPage(1,filters)})}const filterSectionHeaders=document.querySelectorAll('.filter-section-header');filterSectionHeaders.forEach(header=>{header.addEventListener('click',()=>{const section=header.getAttribute('data-section');const content=document.getElementById(`${section}Content`);const isExpanded=header.getAttribute('aria-expanded')==='true';filterSectionHeaders.forEach(h=>{if(h!==header){h.setAttribute('aria-expanded','false');const otherSection=h.getAttribute('data-section');const otherContent=document.getElementById(`${otherSection}Content`);if(otherContent){otherContent.classList.remove('expanded')}}});header.setAttribute('aria-expanded',!isExpanded);if(content){content.classList.toggle('expanded',!isExpanded)}});header.setAttribute('aria-expanded','false');const section=header.getAttribute('data-section');const content=document.getElementById(`${section}Content`);if(content){content.classList.remove('expanded')}});const qualityButtons=document.querySelectorAll('.quality-btn');qualityButtons.forEach(button=>{button.addEventListener('click',()=>{qualityButtons.forEach(btn=>btn.classList.remove('active'));button.classList.add('active');const filters=buildFiltersFromUI();const quality=button.getAttribute('data-quality');if(quality){filters.quality=quality}loadProductsPage(1,filters)})});const brandButtons=document.querySelectorAll('.brand-btn');brandButtons.forEach(button=>{button.addEventListener('click',()=>{brandButtons.forEach(btn=>{if(btn!==button){btn.classList.remove('active')}});button.classList.toggle('active');const filters=buildFiltersFromUI();loadProductsPage(1,filters)})})});function buildFiltersFromUI(){const filters={};const searchInput=document.getElementById('productSearch');if(searchInput&&searchInput.value.trim()){filters.search=searchInput.value.trim()}const activeCategory=document.querySelector('.category-btn.active');if(activeCategory){const category=activeCategory.getAttribute('data-category');if(category&&category!=='all'){filters.category=category}}const activeQuality=document.querySelector('.quality-btn.active');if(activeQuality){const quality=activeQuality.getAttribute('data-quality');if(quality){filters.quality=quality}}const activeBrand=document.querySelector('.brand-btn.active');if(activeBrand){const brandValue=activeBrand.getAttribute('data-brand')||activeBrand.textContent.trim();filters.brand=brandValue}const sortSelect=document.getElementById('sortSelect');if(sortSelect){filters.sort=sortSelect.value}return filters}const productCards=document.querySelectorAll('.product-card');productCards.forEach(card=>{card.addEventListener('mouseenter',function(){this.style.transition='all 0.3s ease-in-out'});card.addEventListener('mouseleave',function(){this.style.transition='all 0.3s ease-in-out'})});const buttons=document.querySelectorAll('.btn');buttons.forEach(button=>{button.addEventListener('mouseenter',function(){this.style.transition='all 0.3s ease-in-out'});button.addEventListener('mouseleave',function(){this.style.transition='all 0.3s ease-in-out'})});function setActiveNavLink(){const currentPath=window.location.pathname;const navLinks=document.querySelectorAll('.nav-link');navLinks.forEach(link=>{link.classList.remove('active');const linkPath=link.getAttribute('href');if(currentPath.includes(linkPath)||(currentPath==='/'&&linkPath==='index.html')||(currentPath.endsWith('/')&&linkPath==='index.html')){link.classList.add('active')}})}document.addEventListener('DOMContentLoaded',setActiveNavLink);const configToggle=document.getElementById('configToggle');const configPanel=document.getElementById('configPanel');const configClose=document.getElementById('configClose');const currencyOptions=document.querySelectorAll('#currencyOptions .config-option');const agentOptions=document.querySelectorAll('#agentOptions .config-option');if(configToggle&&configPanel){configToggle.addEventListener('click',(e)=>{e.stopPropagation();const buttonRect=configToggle.getBoundingClientRect();const panelContent=configPanel.querySelector('.config-panel-content');if(panelContent){const panelWidth=360;const spacing=8;const leftPosition=buttonRect.right-panelWidth-spacing;const topPosition=buttonRect.bottom+spacing;panelContent.style.position='absolute';panelContent.style.top=`${topPosition}px`;panelContent.style.right='auto';panelContent.style.left=`${Math.max(spacing,leftPosition)}px`;panelContent.style.transform='none'}configPanel.classList.add('active');document.body.style.overflow='hidden'});const updatePanelPosition=throttle(()=>{if(configPanel.classList.contains('active')&&configToggle){const buttonRect=configToggle.getBoundingClientRect();const panelContent=configPanel.querySelector('.config-panel-content');if(panelContent){const panelWidth=360;const spacing=8;const leftPosition=buttonRect.right-panelWidth-spacing;const topPosition=buttonRect.bottom+spacing;panelContent.style.left=`${Math.max(spacing,leftPosition)}px`;panelContent.style.top=`${topPosition}px`}}},100);window.addEventListener('resize',updatePanelPosition,{passive:true})}if(configClose&&configPanel){configClose.addEventListener('click',()=>{configPanel.classList.remove('active');document.body.style.overflow=''})}if(configPanel){configPanel.addEventListener('click',(e)=>{if(e.target===configPanel){configPanel.classList.remove('active');document.body.style.overflow=''}})}currencyOptions.forEach(option=>{option.addEventListener('click',()=>{currencyOptions.forEach(opt=>opt.classList.remove('active'));option.classList.add('active');const selectedCurrency=option.getAttribute('data-currency');localStorage.setItem('selectedCurrency',selectedCurrency);updateProductPrices(selectedCurrency)})});agentOptions.forEach(option=>{option.addEventListener('click',()=>{agentOptions.forEach(opt=>opt.classList.remove('active'));option.classList.add('active');const selectedAgent=option.getAttribute('data-agent');localStorage.setItem('selectedAgent',selectedAgent);updateProductLinks(selectedAgent)})});const themeToggle=document.getElementById('themeToggle');if(themeToggle){themeToggle.addEventListener('click',()=>{const currentTheme=document.documentElement.getAttribute('data-theme')||'dark';const newTheme=currentTheme==='dark'?'light':'dark';applyTheme(newTheme)})}function applyTheme(theme){if(theme==='dark'){document.documentElement.setAttribute('data-theme','dark')}else{document.documentElement.setAttribute('data-theme','light')}localStorage.setItem('selectedTheme',theme)}(function(){const savedTheme=localStorage.getItem('selectedTheme')||'dark';document.documentElement.setAttribute('data-theme',savedTheme)})();function getAgentDisplayName(agentCode){const agentOption=document.querySelector(`.agent-option[data-agent="${agentCode}"]`);if(agentOption){const agentNameSpan=agentOption.querySelector('.agent-name');if(agentNameSpan){return agentNameSpan.textContent.trim()}}const agentNames={'Hubbuy':'Hubbuy','KakoBuy':'KakoBuy','Kakobuy':'KakoBuy','MuleBuy':'MuleBuy','Mulebuy':'MuleBuy','CssBuy':'CssBuy','CSSBuy':'CssBuy','cssbuy':'CssBuy','Oopbuy':'Oopbuy','OOPBuy':'Oopbuy','oopbuy':'Oopbuy'};return agentNames[agentCode]||agentCode}function extractBaseUrlFromAgentLink(agentLink){if(!agentLink||typeof agentLink!=='string'){return null}const url=agentLink.trim();if(url.includes('weidian.com')||url.includes('1688.com')||url.includes('taobao.com')){return url}if(url.includes('kakobuy.com/item/details')){const urlMatch=url.match(/[?&]url=([^&]+)/);if(urlMatch&&urlMatch[1]){try{let decodedUrl=decodeURIComponent(urlMatch[1]);if(decodedUrl.includes('%')){decodedUrl=decodeURIComponent(decodedUrl)}if(decodedUrl.includes('weidian.com')||decodedUrl.includes('1688.com')||decodedUrl.includes('taobao.com')){return decodedUrl}}catch(e){}}}if(url.includes('hubbuycn.com')||url.includes('hipobuy')){const match=url.match(/url=([^=&]+)/);if(match){let baseUrl=match[1];if(baseUrl.includes('=product_link')){baseUrl=baseUrl.replace('=product_link','')}try{return decodeURIComponent(baseUrl)}catch(e){return baseUrl}}}const oopbuyMatch=url.match(/oopbuy\.com\/product\/([^\/]+)\/(\d+)/);if(oopbuyMatch){const platform=oopbuyMatch[1];const productId=oopbuyMatch[2];if(platform==='weidian'||platform==='WEIDIAN'){return `https:}else if(platform==='1688'){return `https:}else if(platform==='taobao'){return `https:}}const mulebuyMatch=url.match(/mulebuy\.com\/product\?id=(\d+)&platform=([^&]+)/);if(mulebuyMatch){const productId=mulebuyMatch[1];const platform=mulebuyMatch[2];if(platform==='WEIDIAN'){return `https:}else if(platform==='ALI_1688'){return `https:}else if(platform==='TAOBAO'){return `https:}}const cssbuyMatch=url.match(/cssbuy\.com\/item-(\d+)\.html/i);if(cssbuyMatch){const productId=cssbuyMatch[1];return null}return null}function updateProductLinks(selectedAgent){if(!selectedAgent){selectedAgent=localStorage.getItem('selectedAgent')||document.querySelector('.agent-option.active')?.getAttribute('data-agent')||'Hubbuy'}const agentDisplayName=getAgentDisplayName(selectedAgent);const productLinks=document.querySelectorAll('a[data-agent-link]');productLinks.forEach((link)=>{const card=link.closest('.product-card');if(!card){link.textContent=`Ver en ${agentDisplayName}`;link.href='javascript:void(0);';link.style.opacity='0.5';link.style.cursor='not-allowed';return}let baseUrl=card.getAttribute('data-base-url');if(baseUrl&&baseUrl.trim()!==''){if(baseUrl.includes('kakobuy.com')||baseUrl.includes('hubbuycn.com')||baseUrl.includes('mulebuy.com')||baseUrl.includes('cssbuy.com')||baseUrl.includes('oopbuy.com')){const realBaseUrl=extractBaseUrlFromAgentLink(baseUrl);if(realBaseUrl&&(realBaseUrl.includes('weidian.com')||realBaseUrl.includes('1688.com')||realBaseUrl.includes('taobao.com'))){baseUrl=realBaseUrl}else{baseUrl=null}}else if(!baseUrl.includes('weidian.com')&&!baseUrl.includes('1688.com')&&!baseUrl.includes('taobao.com')){baseUrl=null}}else{baseUrl=null}if(baseUrl&&baseUrl.trim()!==''){(async()=>{const convertedLink=await convertToAgentLink(baseUrl,selectedAgent);if(convertedLink&&convertedLink.trim()!==''&&convertedLink.startsWith('http')){link.href=convertedLink;link.textContent=`Ver en ${agentDisplayName}`;link.style.opacity='';link.style.cursor=''}else{link.href='javascript:void(0);';link.textContent=`Sin link disponible`;link.style.opacity='0.5';link.style.cursor='not-allowed'}})()}else{link.href='javascript:void(0);';link.textContent=`Sin link disponible`;link.style.opacity='0.5';link.style.cursor='not-allowed'}})}function openQCModal(product){const qcModal=document.getElementById('qcModal');const qcModalBody=document.getElementById('qcModalBody');if(!qcModal||!qcModalBody)return;const mainImage=product.imagen_url||product.imagen||'';const qcImages=product.qc_images||[];const images=qcImages.length>0?qcImages:[mainImage].filter(Boolean);let modalHTML='';if(images.length===0){modalHTML=`<div class="qc-no-images"><div class="qc-no-images-icon"></div><p>No hay im谩genes QC disponibles para este producto</p></div>`}else{modalHTML=`<div class="qc-main-image-container"><img src="${images[0]}" alt="${escapeHtml(product.nombre||'Producto')}" class="qc-main-image" id="qcMainImage" loading="lazy" decoding="async"></div>${images.length>1?`<div class="qc-gallery" id="qcGallery">${images.map((img,index)=>`<div class="qc-gallery-item ${index===0?'active':''}" data-image-index="${index}"><img src="${img}" alt="QC ${index+1}" loading="lazy"></div>`).join('')}</div>`:''}<div class="qc-product-info"><h3 class="qc-product-name">${escapeHtml(product.nombre||'Producto')}</h3><div class="qc-product-meta">${product.categoria?`<div class="qc-meta-item"><span class="qc-meta-label">Categor铆a</span><span class="qc-meta-value">${escapeHtml(product.categoria)}</span></div>`:''}${product.calidad?`<div class="qc-meta-item"><span class="qc-meta-label">Calidad</span><span class="qc-meta-value">${escapeHtml(product.calidad)}</span></div>`:''}${product.precio_cny?`<div class="qc-meta-item"><span class="qc-meta-label">Precio</span><span class="qc-meta-value">${formatPrice(product.precio_cny)}CNY</span></div>`:''}</div></div>`}qcModalBody.innerHTML=modalHTML;if(images.length>1){const galleryItems=qcModalBody.querySelectorAll('.qc-gallery-item');const mainImageEl=document.getElementById('qcMainImage');galleryItems.forEach((item,index)=>{item.addEventListener('click',()=>{galleryItems.forEach(i=>i.classList.remove('active'));item.classList.add('active');if(mainImageEl){mainImageEl.src=images[index]}})})}qcModal.classList.add('active');document.body.style.overflow='hidden'}function closeQCModal(){const qcModal=document.getElementById('qcModal');if(qcModal){qcModal.classList.remove('active');document.body.style.overflow=''}}function initQCModal(){const qcModal=document.getElementById('qcModal');const qcModalClose=document.getElementById('qcModalClose');const qcModalBackdrop=qcModal?.querySelector('.qc-modal-backdrop');if(!qcModal)return;if(qcModalClose){qcModalClose.addEventListener('click',closeQCModal)}if(qcModalBackdrop){qcModalBackdrop.addEventListener('click',closeQCModal)}document.addEventListener('keydown',(e)=>{if(e.key==='Escape'&&qcModal.classList.contains('active')){closeQCModal()}});const observer=new MutationObserver(()=>{attachQCListeners()});const productsGrid=document.querySelector('.products-grid');if(productsGrid){observer.observe(productsGrid,{childList:true,subtree:true});attachQCListeners()}}function attachQCListeners(){const productImages=document.querySelectorAll('.product-card .product-image');productImages.forEach((imageContainer)=>{if(imageContainer.dataset.qcListener==='true')return;imageContainer.dataset.qcListener='true';imageContainer.addEventListener('click',(e)=>{e.preventDefault();e.stopPropagation();const card=imageContainer.closest('.product-card');if(!card)return;const productName=card.querySelector('.product-name')?.textContent||'';const productCategory=card.querySelector('.product-meta')?.textContent||'';const productPrice=card.querySelector('.price-cny')?.getAttribute('data-price-cny')||'';const productImage=card.querySelector('.product-image img')?.src||'';const productQuality=card.querySelector('.product-quality')?.textContent||'';const product={nombre:productName,categoria:productCategory,precio_cny:parseFloat(productPrice)||0,imagen_url:productImage,calidad:productQuality,qc_images:[]};const allImages=card.querySelectorAll('.product-image img');if(allImages.length>1){product.qc_images=Array.from(allImages).map(img=>img.src)}openQCModal(product)})})}if(document.readyState==='loading'){document.addEventListener('DOMContentLoaded',initQCModal)}else{initQCModal()}async function loadDatabaseStats(){const totalProductsEl=document.getElementById('totalProducts');const totalCategoriesEl=document.getElementById('totalCategories');const totalQualityEl=document.getElementById('totalQuality');const lastUpdateEl=document.getElementById('lastUpdate');if(!totalProductsEl)return;try{const headers={"apikey":SUPABASE_ANON_KEY,"Authorization":`Bearer ${SUPABASE_ANON_KEY}`,"Content-Type":"application/json"};const query=`${SUPABASE_REST_URL}/products_clean?select=id,categoria,calidad,created_at&activo=eq.true`;const controller=new AbortController();const timeoutId=setTimeout(()=>controller.abort(),10000);const res=await secureSupabaseFetch(query,{headers:headers,signal:controller.signal,});clearTimeout(timeoutId);if(!res.ok){throw new Error(`Error ${res.status}`)}const products=await res.json();const totalProducts=products.length;const categories=new Set();products.forEach(p=>{if(p.categoria){categories.add(p.categoria)}});const totalCategories=categories.size;const quality1to1=products.filter(p=>p.calidad&&p.calidad.toLowerCase().includes('1:1')).length;let lastUpdate='N/A';if(products.length>0){const sortedProducts=products .filter(p=>p.created_at).sort((a,b)=>new Date(b.created_at)-new Date(a.created_at));if(sortedProducts.length>0){const lastDate=new Date(sortedProducts[0].created_at);const now=new Date();const diffDays=Math.floor((now-lastDate)/(1000*60*60*24));if(diffDays===0){lastUpdate='Hoy'}else if(diffDays===1){lastUpdate='Ayer'}else if(diffDays<7){lastUpdate=`Hace ${diffDays}d铆as`}else{lastUpdate=lastDate.toLocaleDateString('es-AR',{day:'numeric',month:'short'})}}}animateValue(totalProductsEl,0,totalProducts,1000);animateValue(totalCategoriesEl,0,totalCategories,1000);animateValue(totalQualityEl,0,quality1to1,1000);if(lastUpdateEl){lastUpdateEl.textContent=lastUpdate}}catch(error){console.error('Error loading database stats:',error);if(totalProductsEl)totalProductsEl.textContent='1,500+';if(totalCategoriesEl)totalCategoriesEl.textContent='6+';if(totalQualityEl)totalQualityEl.textContent='500+';if(lastUpdateEl)lastUpdateEl.textContent='Reciente'}}function animateValue(element,start,end,duration){if(!element)return;const range=end-start;const increment=range/(duration/16);let current=start;const timer=setInterval(()=>{current+=increment;if((increment>0&&current>=end)||(increment<0&&current<=end)){current=end;clearInterval(timer)}const formatted=Math.floor(current).toLocaleString('es-AR');element.textContent=formatted},16)}if(document.readyState==='loading'){document.addEventListener('DOMContentLoaded',()=>{if(window.location.pathname.includes('productos.html')){loadDatabaseStats()}})}else{if(window.location.pathname.includes('productos.html')){loadDatabaseStats()}}let exchangeRates={CNY:1.0,USD:0.155,ARS:225.525,CLP:144.15};async function fetchExchangeRates(){try{try{const response=await fetch('https:if(response.ok){const data=await response.json();const oficial=data.find(item=>item.casa.nombre==='Dolar Oficial');if(oficial&&oficial.casa.venta){const ventaOficial=parseFloat(oficial.casa.venta.replace(',','.'));if(!isNaN(ventaOficial)){exchangeRates.ARS=ventaOficial;return}}}}catch(e){exchangeRates.ARS=1455}}catch(e){exchangeRates.ARS=1455}}function updateProductPrices(selectedCurrency){const priceElements=document.querySelectorAll('.price-cny[data-price-cny]');let formatPriceFn;switch(selectedCurrency){case 'CNY':formatPriceFn=(priceCNY)=>`楼${priceCNY.toFixed(2)}CNY`;break;case 'USD':formatPriceFn=(priceCNY)=>{const convertedPrice=priceCNY*exchangeRates.USD;return `$${convertedPrice.toFixed(2)}USD`};break;case 'ARS':formatPriceFn=(priceCNY)=>{const convertedPrice=priceCNY*exchangeRates.ARS;return `$${Math.round(convertedPrice).toLocaleString('es-AR')}ARS`};break;case 'CLP':formatPriceFn=(priceCNY)=>{const convertedPrice=priceCNY*exchangeRates.CLP;return `$${Math.round(convertedPrice).toLocaleString('es-CL')}CLP`};break;default:formatPriceFn=(priceCNY)=>`楼${priceCNY.toFixed(2)}CNY`}if(priceElements.length>20){let index=0;const updateBatch=()=>{const batchSize=10;const end=Math.min(index+batchSize,priceElements.length);for(let i=index;i<end;i++){const priceEl=priceElements[i];const originalPriceText=priceEl.getAttribute('data-price-cny');if(!originalPriceText)continue;const priceCNY=parseFloat(originalPriceText);if(isNaN(priceCNY))continue;const formattedPrice=formatPriceFn(priceCNY);priceEl.textContent=`Desde ${formattedPrice}`}index=end;if(index<priceElements.length){requestAnimationFrame(updateBatch)}};requestAnimationFrame(updateBatch)}else{priceElements.forEach(priceEl=>{const originalPriceText=priceEl.getAttribute('data-price-cny');if(!originalPriceText)return;const priceCNY=parseFloat(originalPriceText);if(isNaN(priceCNY))return;const formattedPrice=formatPriceFn(priceCNY);priceEl.textContent=`Desde ${formattedPrice}`})}}document.addEventListener('DOMContentLoaded',async()=>{await fetchExchangeRates();const savedTheme=localStorage.getItem('selectedTheme')||'dark';const currentTheme=document.documentElement.getAttribute('data-theme');if(currentTheme!==savedTheme){applyTheme(savedTheme)}const savedCurrency=localStorage.getItem('selectedCurrency');const savedAgent=localStorage.getItem('selectedAgent');if(savedCurrency){currencyOptions.forEach(option=>{if(option.getAttribute('data-currency')===savedCurrency){currencyOptions.forEach(opt=>opt.classList.remove('active'));option.classList.add('active');updateProductPrices(savedCurrency)}})}else{const defaultCurrency='CNY';updateProductPrices(defaultCurrency)}if(savedAgent){agentOptions.forEach(option=>{if(option.getAttribute('data-agent')===savedAgent){agentOptions.forEach(opt=>opt.classList.remove('active'));option.classList.add('active');updateProductLinks(savedAgent)}})}else{const defaultAgent='Hubbuy';if(document.querySelectorAll('a[data-agent-link]').length>0){updateProductLinks(defaultAgent)}}});document.addEventListener("DOMContentLoaded",()=>{const compraInput=document.getElementById("compraUSD");const envioInput=document.getElementById("envioUSD");const impuestosUSD=document.getElementById("impuestosUSD");const impuestosARS=document.getElementById("impuestosARS");const limpiarBtn=document.getElementById("limpiarCalc");const toggleFranquicia=document.getElementById("toggleFranquicia");const toggleTasaGestion=document.getElementById("toggleTasaGestion");const calculationSummary=document.getElementById("calculationSummary");const franquiciaStatus=document.getElementById("franquiciaStatus");const configAccordionToggle=document.getElementById("configAccordionToggle");const configCard=document.getElementById("configCard");if(!compraInput||!envioInput||!impuestosUSD||!impuestosARS||!limpiarBtn){return}const dolarOficialDisplay=document.getElementById("dolarOficial");const contadoLiquiDisplay=document.getElementById("contadoLiqui");let DOLAR_OFICIAL=1455;let CONTADO_LIQUI=1513.90;const FRANQUICIA=50;const TASA_GESTION=4.95;async function fetchExchangeRates(){try{try{const response=await fetch('https:if(response.ok){const data=await response.json();const oficial=data.find(item=>item.casa.nombre==='Dolar Oficial');const ccl=data.find(item=>item.casa.nombre==='Contado con Liquidacion'||item.casa.nombre==='Dolar Contado con Liquidacion');if(oficial&&oficial.casa.venta){const ventaOficial=parseFloat(oficial.casa.venta.replace(',','.'));if(!isNaN(ventaOficial)){DOLAR_OFICIAL=ventaOficial;if(dolarOficialDisplay){dolarOficialDisplay.textContent=`$${DOLAR_OFICIAL.toFixed(2)}`}}}if(ccl&&ccl.casa.venta){const ventaCCL=parseFloat(ccl.casa.venta.replace(',','.'));if(!isNaN(ventaCCL)){CONTADO_LIQUI=ventaCCL;if(contadoLiquiDisplay){contadoLiquiDisplay.textContent=`$${CONTADO_LIQUI.toFixed(2)}`}}}}}catch(e){}calcular()}catch(error){}}if('requestIdleCallback' in window){requestIdleCallback(fetchExchangeRates,{timeout:2000})}else{setTimeout(fetchExchangeRates,100)}setInterval(()=>{if('requestIdleCallback' in window){requestIdleCallback(fetchExchangeRates)}else{fetchExchangeRates()}},30*60*1000);function animateNumber(element){element.classList.add("animate");setTimeout(()=>{element.classList.remove("animate")},400)}function updateFranquiciaStatus(usarFranquicia){if(!franquiciaStatus)return;if(usarFranquicia){franquiciaStatus.textContent="Franquicia aplicada:-$50"}else{franquiciaStatus.textContent="Franquicia no aplicada"}}function updateSummary(usarTasaGestion){if(!calculationSummary)return;let summary="Estimaci贸n:50%de la base imponible";if(usarTasaGestion){summary+="+tasa fija($4.95 USD)"}calculationSummary.textContent=summary}function calcular(){const compra=parseFloat(compraInput.value)||0;const envio=parseFloat(envioInput.value)||0;const totalUSD=compra+envio;const usarFranquicia=toggleFranquicia?toggleFranquicia.checked:true;const usarTasaGestion=toggleTasaGestion?toggleTasaGestion.checked:true;let baseImponible;if(usarFranquicia){baseImponible=Math.max(0,totalUSD-FRANQUICIA)}else{baseImponible=totalUSD}let impuestos=(baseImponible*0.5);if(usarTasaGestion){impuestos+=TASA_GESTION}const prevUSD=impuestosUSD.textContent;const prevARS=impuestosARS.textContent;impuestosUSD.textContent=`$${impuestos.toFixed(2)}`;const impuestosARSValue=impuestos*DOLAR_OFICIAL;impuestosARS.textContent=`$${impuestosARSValue.toLocaleString("es-AR",{minimumFractionDigits:2,maximumFractionDigits:2,useGrouping:true})}`;const dolarOficialNote=document.getElementById("dolarOficialNote");if(dolarOficialNote){dolarOficialNote.textContent=`D贸lar Oficial:$${DOLAR_OFICIAL.toFixed(2)}`}if(prevUSD!==impuestosUSD.textContent){animateNumber(impuestosUSD)}if(prevARS!==impuestosARS.textContent){animateNumber(impuestosARS)}updateFranquiciaStatus(usarFranquicia);updateSummary(usarTasaGestion)}compraInput.addEventListener("input",calcular);envioInput.addEventListener("input",calcular);if(toggleFranquicia){toggleFranquicia.addEventListener("change",calcular)}if(toggleTasaGestion){toggleTasaGestion.addEventListener("change",calcular)}limpiarBtn.addEventListener("click",()=>{compraInput.value="";envioInput.value="";impuestosUSD.textContent="$0.00";impuestosARS.textContent="$0.00";if(calculationSummary){calculationSummary.textContent="Estimaci贸n:50%de la base imponible+tasa fija(si aplica)"}if(franquiciaStatus){const usarFranquicia=toggleFranquicia?toggleFranquicia.checked:true;updateFranquiciaStatus(usarFranquicia)}animateNumber(impuestosUSD);animateNumber(impuestosARS)});calcular()});document.addEventListener('DOMContentLoaded',()=>{const registerModal=document.getElementById('registerModal');const registerModalClose=document.getElementById('registerModalClose');const registerModalBackdrop=registerModal?.querySelector('.register-modal-backdrop');const isHomePage=window.location.pathname.endsWith('index.html')||window.location.pathname.endsWith('/')||window.location.pathname===''||!window.location.pathname.includes('.html');if(!registerModal||!isHomePage)return;const showModal=()=>{const show=()=>{registerModal.classList.add('active');if(window.innerWidth>640){document.body.style.overflow='hidden'}};if('requestIdleCallback' in window){requestIdleCallback(show,{timeout:3000})}else{setTimeout(()=>requestAnimationFrame(show),3000)}};if(document.readyState==='complete'){setTimeout(showModal,2000)}else{window.addEventListener('load',()=>{setTimeout(showModal,2000)},{once:true})}const closeModal=()=>{registerModal.classList.remove('active');document.body.style.overflow=''};if(registerModalClose){registerModalClose.addEventListener('click',closeModal)}if(registerModalBackdrop){registerModalBackdrop.addEventListener('click',closeModal)}document.addEventListener('keydown',(e)=>{if(e.key==='Escape'&&registerModal.classList.contains('active')){closeModal()}})});document.addEventListener('DOMContentLoaded',()=>{const wheelWidget=document.getElementById('wheelWidget');const wheelToggleBtn=document.getElementById('wheelToggleBtn');const wheelPopup=document.getElementById('wheelPopup');const wheelPopupClose=document.getElementById('wheelPopupClose');const wheelSpinCenter=document.getElementById('wheelSpinCenter');const wheelMain=document.getElementById('wheelMain');const prizeModal=document.getElementById('prizeModal');const prizeCloseBtn=document.getElementById('prizeCloseBtn');const prizeText=document.getElementById('prizeText');const isHomePage=window.location.pathname.endsWith('index.html')||window.location.pathname.endsWith('/')||window.location.pathname===''||!window.location.pathname.includes('.html');if(!wheelWidget||!isHomePage)return;let isSpinning=false;let isPopupOpen=false;const lastSpinDate=localStorage.getItem('lastWheelSpin');const today=new Date().toDateString();const hasSpunToday=lastSpinDate===today;if(hasSpunToday&&wheelToggleBtn){const toggleText=wheelToggleBtn.querySelector('.wheel-toggle-text');if(toggleText){toggleText.textContent='Ya jugaste hoy'}wheelToggleBtn.style.opacity='0.7'}const togglePopup=()=>{if(hasSpunToday&&!isPopupOpen){return}isPopupOpen=!isPopupOpen;if(wheelPopup){wheelPopup.classList.toggle('active',isPopupOpen)}};if(wheelToggleBtn){wheelToggleBtn.addEventListener('click',togglePopup)}const closePopup=()=>{isPopupOpen=false;if(wheelPopup){wheelPopup.classList.remove('active')}};if(wheelPopupClose){wheelPopupClose.addEventListener('click',(e)=>{e.stopPropagation();closePopup()})}const closePrizeModal=()=>{if(prizeModal){prizeModal.classList.remove('active')}};if(prizeCloseBtn){prizeCloseBtn.addEventListener('click',closePrizeModal)}if(prizeModal){prizeModal.querySelector('.prize-modal-backdrop')?.addEventListener('click',closePrizeModal)}const spinWheel=()=>{if(isSpinning||hasSpunToday)return;isSpinning=true;if(wheelSpinCenter){wheelSpinCenter.disabled=true}if(wheelMain){wheelMain.classList.add('spinning');wheelMain.style.willChange='transform';wheelMain.style.transform='translateZ(0)'}const targetAngle=0;const spins=5;const finalAngle=spins*360+(360-targetAngle);requestAnimationFrame(()=>{if(wheelMain){wheelMain.style.transform=`translateZ(0)rotate(${finalAngle}deg)`}});setTimeout(()=>{isSpinning=false;if(wheelMain){wheelMain.classList.remove('spinning');wheelMain.style.willChange='auto'}localStorage.setItem('lastWheelSpin',today);if(prizeText){prizeText.textContent='Env铆o Gratis'}closePopup();setTimeout(()=>{if(prizeModal){prizeModal.classList.add('active')}if(wheelToggleBtn){const toggleText=wheelToggleBtn.querySelector('.wheel-toggle-text');if(toggleText){toggleText.textContent='Ya jugaste hoy'}wheelToggleBtn.style.opacity='0.7'}},300)},3000)};if(wheelSpinCenter){wheelSpinCenter.addEventListener('click',spinWheel)}document.addEventListener('keydown',(e)=>{if(e.key==='Escape'){if(isPopupOpen){closePopup()}if(prizeModal&&prizeModal.classList.contains('active')){closePrizeModal()}}})});document.addEventListener('DOMContentLoaded',()=>{const stepHeaders=document.querySelectorAll('.step-header');stepHeaders.forEach(header=>{header.addEventListener('click',()=>{const stepNumber=header.getAttribute('data-step');const content=document.getElementById(`step-content-${stepNumber}`);if(!content)return;const isActive=header.classList.contains('active');if(isActive){header.classList.remove('active');content.classList.remove('expanded')}else{header.classList.add('active');content.classList.add('expanded')}})});const firstStep=document.querySelector('.step-header[data-step="1"]');if(firstStep){const firstContent=document.getElementById('step-content-1');if(firstContent){firstStep.classList.add('active');firstContent.classList.add('expanded')}}});const AUTHORIZED_DOMAINS=['repshub.vercel.app','www.repshub.vercel.app','repshub1.vercel.app','www.repshub1.vercel.app','fashionreps.vercel.app','www.fashionreps.vercel.app','localhost','127.0.0.1'];let sessionToken=null;let sessionExpiresAt=null;function isAuthorizedDomain(){const currentDomain=window.location.hostname;const currentOrigin=window.location.origin;return AUTHORIZED_DOMAINS.some(authorized=>{return currentDomain===authorized||currentDomain.includes(authorized)||currentOrigin.includes(authorized)})}async function validateDomain(){try{const currentDomain=window.location.hostname;const currentOrigin=window.location.origin;const response=await fetch('/api/validate-domain',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({domain:currentDomain,origin:currentOrigin})});const data=await response.json();if(data.ok&&data.authorized){sessionToken=data.sessionToken;sessionExpiresAt=data.expiresAt;return true}return false}catch(error){return false}}function isSessionValid(){if(!sessionToken||!sessionExpiresAt){return false}return Date.now()<sessionExpiresAt}async function secureSupabaseFetch(url,options={}){if(!isAuthorizedDomain()){throw new Error('Acceso denegado:Dominio no autorizado')}if(!isSessionValid()){try{const isValid=await validateDomain();if(!isValid){if(isAuthorizedDomain()){return fetch(url,options)}throw new Error('Acceso denegado:Validaci贸n de dominio fallida')}}catch(error){if(isAuthorizedDomain()){return fetch(url,options)}throw error}}const secureOptions={...options,headers:{...options.headers,'X-Session-Token':sessionToken||''}};return fetch(url,secureOptions)}function showUnauthorizedError(){const errorDiv=document.createElement('div');errorDiv.id='unauthorized-error';errorDiv.style.cssText=` position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.95);color:#ff4444;display:flex;align-items:center;justify-content:center;z-index:999999;font-family:Arial,sans-serif;font-size:1.5rem;text-align:center;padding:2rem;`;errorDiv.innerHTML=`<div><h1 style="color:#ff4444;margin-bottom:1rem;">Acceso Denegado</h1><p>Este sitio solo es accesible desde dominios autorizados.</p><p style="font-size:1rem;margin-top:1rem;color:#ccc;">Si crees que esto es un error,contacta al administrador.</p></div>`;document.body.appendChild(errorDiv)}(async function initSecurity(){if(!isAuthorizedDomain()){showUnauthorizedError();return}try{const isValid=await validateDomain();if(!isValid&&!isAuthorizedDomain()){showUnauthorizedError();return}}catch(error){if(!isAuthorizedDomain()){showUnauthorizedError();return}}})();(function(){'use strict';if(!isAuthorizedDomain()){let devtools={open:false,orientation:null};const threshold=160;setInterval(()=>{if(window.outerHeight-window.innerHeight>threshold||window.outerWidth-window.innerWidth>threshold){if(!devtools.open){devtools.open=true;document.body.innerHTML='<div style="display:flex;align-items:center;justify-content:center;height:100vh;font-size:2rem;color:#ff4444;">Acceso denegado:DevTools detectado</div>'}}else{devtools.open=false}},500)}if(!isAuthorizedDomain()){document.addEventListener('keydown',function(e){if(e.keyCode===123){e.preventDefault();e.stopPropagation();return false}if(e.ctrlKey&&e.shiftKey&&e.keyCode===73){e.preventDefault();e.stopPropagation();return false}if(e.ctrlKey&&e.shiftKey&&e.keyCode===74){e.preventDefault();e.stopPropagation();return false}if(e.ctrlKey&&e.shiftKey&&e.keyCode===67){e.preventDefault();e.stopPropagation();return false}if(e.ctrlKey&&e.keyCode===85){e.preventDefault();e.stopPropagation();return false}if(e.ctrlKey&&e.keyCode===83){e.preventDefault();e.stopPropagation();return false}if(e.ctrlKey&&e.keyCode===65){e.preventDefault();e.stopPropagation();return false}if(e.ctrlKey&&e.keyCode===67&&!e.shiftKey){e.preventDefault();e.stopPropagation();return false}if(e.ctrlKey&&e.keyCode===86){e.preventDefault();e.stopPropagation();return false}if(e.ctrlKey&&e.keyCode===88){e.preventDefault();e.stopPropagation();return false}if(e.ctrlKey&&e.keyCode===80){e.preventDefault();e.stopPropagation();return false}})}if(!isAuthorizedDomain()){document.addEventListener('contextmenu',function(e){e.preventDefault();e.stopPropagation();return false});document.addEventListener('selectstart',function(e){e.preventDefault();e.stopPropagation();return false});document.addEventListener('dragstart',function(e){e.preventDefault();e.stopPropagation();return false});document.addEventListener('copy',function(e){e.clipboardData.setData('text/plain','');e.preventDefault();e.stopPropagation();return false});document.addEventListener('cut',function(e){e.clipboardData.setData('text/plain','');e.preventDefault();e.stopPropagation();return false});const style=document.createElement('style');style.textContent=`*{-webkit-user-select:none!important;-moz-user-select:none!important;-ms-user-select:none!important;user-select:none!important;-webkit-touch-callout:none!important;-webkit-tap-highlight-color:transparent!important}input,textarea{-webkit-user-select:text!important;-moz-user-select:text!important;-ms-user-select:text!important;user-select:text!important}`;document.head.appendChild(style)}if(!isAuthorizedDomain()){const noop=()=>{};const methods=['log','debug','info','warn','error','assert','dir','dirxml','group','groupEnd','time','timeEnd','count','trace','profile','profileEnd'];methods.forEach(method=>{window.console[method]=noop});try{Object.defineProperty(window,'console',{value:{},writable:false,configurable:false})}catch(e){}}})();(function detectUnauthorizedExecution(){'use strict';const currentDomain=window.location.hostname;const isAuthorized=AUTHORIZED_DOMAINS.some(domain=>currentDomain===domain||currentDomain.includes(domain));if(!isAuthorized){window.addEventListener('load',function(){document.body.innerHTML=`<div style="display:flex;align-items:center;justify-content:center;height:100vh;font-size:1.5rem;color:#ff4444;text-align:center;padding:2rem;font-family:Arial,sans-serif;"><div><h1 style="color:#ff4444;margin-bottom:1rem;">C贸digo Protegido</h1><p>Este c贸digo solo puede ejecutarse desde dominios autorizados.</p><p style="font-size:1rem;margin-top:1rem;color:#ccc;">El c贸digo est谩 protegido y no funcionar谩 fuera del entorno autorizado.</p></div></div>`});window.fetch=function(){return Promise.reject(new Error('Acceso denegado'))};return}const codeIntegrity={check:function(){if(typeof secureSupabaseFetch!=='function'||typeof validateDomain!=='function'||typeof isAuthorizedDomain!=='function'){console.error('Integridad del c贸digo comprometida');return false}return true}};setInterval(()=>{if(!codeIntegrity.check()){document.body.innerHTML='<div style="display:flex;align-items:center;justify-content:center;height:100vh;font-size:2rem;color:#ff4444;">C贸digo modificado detectado</div>'}},5000)})();const SUPABASE_URL="https:const SUPABASE_ANON_KEY="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InN6b2hwa2NndWJja3hvYXVzcG1yIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njk0NTMwNTksImV4cCI6MjA4NTAyOTA1OX0.bSbr61juTNd0Y4LchHjT2YbvCl-uau2GN83V-2HhkWE";const SUPABASE_REST_URL=`${SUPABASE_URL}/rest/v1`;function escapeHtml(str){return String(str??"").replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;").replaceAll('"',"&quot;").replaceAll("'","&#039;")}function formatPrice(price){if(price===null||price===undefined||isNaN(price)){return '0.00'}return parseFloat(price).toFixed(2)}async function convertToAgentLink(baseUrl,agent){if(!baseUrl||!baseUrl.trim()||!agent){return ''}let url=baseUrl.trim();if(url.includes('kakobuy.com')||url.includes('hubbuycn.com')||url.includes('mulebuy.com')||url.includes('cssbuy.com')||url.includes('oopbuy.com')){const extractedBase=extractBaseUrlFromAgentLink(url);if(extractedBase&&(extractedBase.includes('weidian.com')||extractedBase.includes('1688.com')||extractedBase.includes('taobao.com'))){url=extractedBase}else{return ''}}if(!url.includes('weidian.com')&&!url.includes('1688.com')&&!url.includes('taobao.com')){return ''}let productId='';let platform='';const weidianMatch=url.match(/weidian\.com\/item\.html\?itemID=(\d+)/i);if(weidianMatch){productId=weidianMatch[1];platform='WEIDIAN'}const ali1688Match=url.match(/1688\.com\/offer\/(\d+)/i);if(ali1688Match){productId=ali1688Match[1];platform='ALI_1688'}const taobaoMatch=url.match(/taobao\.com\/item\.htm\?id=(\d+)/i);if(taobaoMatch){productId=taobaoMatch[1];platform='TAOBAO'}if(!productId){return ''}switch(agent){case 'KakoBuy':case 'Kakobuy':case 'kakobuy':const encodedUrl=encodeURIComponent(url);return `https:case 'CssBuy':case 'CSSBuy':case 'cssbuy':if(productId){return `https:}return url;case 'Oopbuy':case 'OOPBuy':case 'oopbuy':const platformLower=platform.toLowerCase();let oopbuyPlatform=platformLower;if(platform==='ALI_1688'){oopbuyPlatform='1688'}else if(platform==='TAOBAO'){oopbuyPlatform='taobao'}return `https:case 'Hubbuy':case 'hubbuy':const encodedHubbuyUrl=encodeURIComponent(url);return `https:case 'MuleBuy':case 'Mulebuy':case 'mulebuy':return `https:default:return url}}function normalizeImgurUrl(url){if(!url||typeof url!=='string'){return url}const originalUrl=url.trim();if(!originalUrl.includes('imgur.com')){return originalUrl}if(originalUrl.includes('i.imgur.com')){if(!originalUrl.match(/\.(jpg|jpeg|png|gif|webp)$/i)){return originalUrl+'.jpg'}return originalUrl}const imgurMatch=originalUrl.match(/imgur\.com\/(?:a\/|gallery\/)?([a-zA-Z0-9]+)(?:\.[a-z]+)?/);if(imgurMatch){return `https:}return originalUrl}function mapProductCategory(product){const nombre=(product.nombre||'').toLowerCase();const categoria=(product.categoria||'').toLowerCase();const descripcion=(product.descripcion||'').toLowerCase();const textoCompleto=`${nombre}${categoria}${descripcion}`;if(textoCompleto.includes('conjunto')||textoCompleto.includes('set')){return 'conjuntos'}const tieneZapatilla=textoCompleto.includes('zapatilla')||textoCompleto.includes('zapatillas');const palabrasExcluidas=['box','boxes','caja','cajas','storage','almacenamiento','organizer','organizador','rack','estante','display','case','estuche','bag','bolso','mochila','backpack','cleaner','limpiador','spray','brush','cepillo','lace','cord贸n','cordones','insole','plantilla','sock','calcet铆n','calcetines','socks','bracelet','joyer铆a','joyeria','jewelry','remera','remeras','tee','shirt','camiseta','short','shorts','pantalon','pantalones','pants','sweatpants','decoraci贸n','decoracion','decoration'];const tieneExcluidas=palabrasExcluidas.some(palabra=>textoCompleto.includes(palabra));if(tieneZapatilla&&!tieneExcluidas){return 'calzado'}if((textoCompleto.includes('sneaker')||textoCompleto.includes('sneakers'))&&!tieneExcluidas){return 'calzado'}if(textoCompleto.includes('campera')||textoCompleto.includes('buzo')||textoCompleto.includes('remera')||textoCompleto.includes('camiseta')||textoCompleto.includes('camisa')||textoCompleto.includes('su茅ter')||textoCompleto.includes('hoodie')||textoCompleto.includes('sweater')||textoCompleto.includes('jacket')||textoCompleto.includes('shirt')){return 'ropa-superior'}if(textoCompleto.includes('pantalon')||textoCompleto.includes('jean')||textoCompleto.includes('jogger')||textoCompleto.includes('short')||textoCompleto.includes('pants')||textoCompleto.includes('trouser')){return 'ropa-inferior'}return 'accesorios'}function renderProducts(products){const grid=document.querySelector('.products-grid')||document.getElementById('products-grid');if(!grid)return;const fragment=document.createDocumentFragment();if(!products.length){grid.innerHTML=`<p style="color:#fff;opacity:.8;">No hay productos todav铆a.</p>`;return}const placeholderImg='https:for(const p of products){let imagenUrl=p.imagen_url||'';if(imagenUrl){imagenUrl=normalizeImgurUrl(imagenUrl)}else{imagenUrl=placeholderImg}const card=document.createElement("article");card.className="product-card slide-up";const mappedCategory=mapProductCategory(p);card.setAttribute('data-category',mappedCategory);card.setAttribute('data-quality',(p.calidad||'').toLowerCase());card.setAttribute('data-base-url',p.source_url||'');const precioFormateado=formatPrice(p.precio_cny||0);const nombreEscapado=escapeHtml(p.nombre);const categoriaEscapada=escapeHtml(p.categoria||'');const calidadBadge=p.calidad?`<span class="badge-quality product-quality">${escapeHtml(p.calidad)}</span>`:'';card.innerHTML=`<div class="product-image"><img src="${imagenUrl}" alt="${nombreEscapado}" loading="lazy" decoding="async" onerror="this.onerror=null;this.src='${placeholderImg}';">${calidadBadge}</div><div class="product-info"><h3 class="product-name">${nombreEscapado}</h3><p class="product-meta">${categoriaEscapada}</p><div class="product-price"><span class="price-cny" data-price-cny="${p.precio_cny||0}">Desde ${precioFormateado}CNY</span></div><div class="product-actions"><a class="btn btn-primary" href="javascript:void(0);" target="_blank" rel="noopener noreferrer" data-agent-link>Ver producto</a></div></div>`;fragment.appendChild(card)}grid.innerHTML="";grid.appendChild(fragment);initScrollAnimations();requestAnimationFrame(()=>{updateProductLinks();const savedCurrency=localStorage.getItem('selectedCurrency')||'CNY';updateProductPrices(savedCurrency);attachQCListeners()})}async function loadFeaturedProducts(){const carouselTrack=document.querySelector('#productCarousel .carousel-track');if(!carouselTrack)return;try{const headers={"apikey":SUPABASE_ANON_KEY,"Authorization":`Bearer ${SUPABASE_ANON_KEY}`,"Content-Type":"application/json"};const query=`${SUPABASE_REST_URL}/products_clean?select=*&activo=eq.true&limit=50&order=created_at.desc`;const controller=new AbortController();const timeoutId=setTimeout(()=>controller.abort(),10000);const res=await secureSupabaseFetch(query,{headers:headers,signal:controller.signal,});clearTimeout(timeoutId);if(!res.ok){const txt=await res.text();throw new Error(`Supabase error ${res.status}:${txt}`)}let products=await res.json();if(products.length===0){return}const shuffled=products.sort(()=>0.5-Math.random());const selectedProducts=shuffled.slice(0,5);carouselTrack.innerHTML='';selectedProducts.forEach((product)=>{let image=product.imagen_url||'';if(image){image=normalizeImgurUrl(image)}else{image='https:}const carouselItem=document.createElement('div');carouselItem.className='carousel-item';carouselItem.innerHTML=`<a href="productos.html" class="carousel-product-card"><div class="carousel-product-image"><img src="${image}" alt="${escapeHtml(product.nombre)}" loading="lazy" decoding="async" onerror="this.onerror=null;this.src='https:</div><h3 class="carousel-product-name">${escapeHtml(product.nombre)}</h3></a>`;carouselTrack.appendChild(carouselItem)});const originalItems=Array.from(carouselTrack.querySelectorAll('.carousel-item'));const originalCount=originalItems.length;if(originalCount===0)return;const fragment=document.createDocumentFragment();for(let i=0;i<6;i++){originalItems.forEach(item=>{const clone=item.cloneNode(true);const cloneImg=clone.querySelector('img');if(cloneImg){const originalImg=item.querySelector('img');if(originalImg&&originalImg.src){cloneImg.src=originalImg.src}cloneImg.loading='lazy';cloneImg.decoding='async';cloneImg.style.width='100%';cloneImg.style.height='100%';cloneImg.style.objectFit='cover'}fragment.appendChild(clone)})}carouselTrack.appendChild(fragment);carouselTrack.style.animation='scroll 60s linear infinite';carouselTrack.style.willChange='transform';carouselTrack.style.minWidth='max-content';carouselTrack.style.width='max-content';carouselTrack.style.flexWrap='nowrap';requestAnimationFrame(()=>{void carouselTrack.offsetHeight})}catch(error){}}let currentPage=1;let totalPages=1;let currentFilters={};const PRODUCTS_PER_PAGE=36;async function loadProductsFromAPI(page=1,pageSize=36,filters={}){const headers={"apikey":SUPABASE_ANON_KEY,"Authorization":`Bearer ${SUPABASE_ANON_KEY}`,"Content-Type":"application/json"};let query=`${SUPABASE_REST_URL}/products_clean?select=*&activo=eq.true`;if(filters.quality){query+=`&calidad=eq.${encodeURIComponent(filters.quality)}`}if(filters.search){query+=`&nombre=ilike.%25${encodeURIComponent(filters.search)}%25`}if(filters.brand){let brandNormalized=filters.brand.toLowerCase().trim();const brandSearchMap={'acne-studios':'acne','saint-laurent':'saint laurent','enfants-riches-deprimes':'enfants riches','lostkidsclub2000':'lost kids','martine-rose':'martine rose','sin-marca':null,'alo':'alo','balenciaga':'balenciaga','burberry':'burberry','chai':'chai','gymshark':'gymshark','jordan':'jordan','longchamp':'longchamp','mowalola':'mowalola','nike':'nike','palace':'palace','supreme':'supreme','synaworld':'synaworld','valley':'valley'};if(brandSearchMap.hasOwnProperty(brandNormalized)){if(brandSearchMap[brandNormalized]===null){}else{brandNormalized=brandSearchMap[brandNormalized];query+=`&nombre=ilike.%25${encodeURIComponent(brandNormalized)}%25`}}else{query+=`&nombre=ilike.%25${encodeURIComponent(brandNormalized)}%25`}}if(filters.sort){switch(filters.sort){case 'precio-asc':query+=`&order=precio_cny.asc`;break;case 'precio-desc':query+=`&order=precio_cny.desc`;break;case 'nombre-asc':query+=`&order=nombre.asc`;break;case 'nombre-desc':query+=`&order=nombre.desc`;break;case 'recientes':default:query+=`&order=created_at.desc`;break}}else{query+=`&order=created_at.desc`}const needsClientFiltering=filters.category&&filters.category!=='all';if(needsClientFiltering){headers['Range']=`0-999`;headers['Prefer']='count=exact'}else{const from=(page-1)*pageSize;const to=from+pageSize-1;headers['Range']=`${from}-${to}`;headers['Prefer']='count=exact'}const controller=new AbortController();const timeoutId=setTimeout(()=>controller.abort(),8000);try{const res=await secureSupabaseFetch(query,{headers:headers,signal:controller.signal,cache:'default'});clearTimeout(timeoutId);if(!res.ok){const txt=await res.text();throw new Error(`Supabase error ${res.status}:${txt}`)}let products=await res.json();if(filters.category&&filters.category!=='all'&&products&&products.length>0){const filterCategoryNormalized=filters.category.toLowerCase();products=products.filter(product=>{const mappedCategory=mapProductCategory(product);return mappedCategory===filterCategoryNormalized})}if(filters.sort&&products&&products.length>0){switch(filters.sort){case 'precio-asc':products.sort((a,b)=>(parseFloat(a.precio_cny||0)-parseFloat(b.precio_cny||0)));break;case 'precio-desc':products.sort((a,b)=>(parseFloat(b.precio_cny||0)-parseFloat(a.precio_cny||0)));break;case 'nombre-asc':products.sort((a,b)=>(a.nombre||'').localeCompare(b.nombre||''));break;case 'nombre-desc':products.sort((a,b)=>(b.nombre||'').localeCompare(a.nombre||''));break}}let totalCount=parseInt(res.headers.get('content-range')?.split('/')[1]||'0');if(needsClientFiltering){totalCount=products.length;const startIndex=(page-1)*pageSize;const endIndex=startIndex+pageSize;const paginatedProducts=products.slice(startIndex,endIndex);const totalPages=Math.ceil(totalCount/pageSize);return{products:paginatedProducts||[],totalCount:totalCount,totalPages:totalPages||1,currentPage:page}}else{const totalPages=Math.ceil(totalCount/pageSize);return{products:products||[],totalCount:totalCount,totalPages:totalPages||1,currentPage:page}}}catch(error){clearTimeout(timeoutId);if(error.name==='AbortError'){throw new Error('Request timeout:No se pudo cargar los productos')}throw error}}if(typeof window!=='undefined'){window.loadProductsFromAPI=loadProductsFromAPI}async function loadProductsPage(page=1,filters={}){const grid=document.querySelector('.products-grid')||document.getElementById('products-grid');if(!grid)return;if(typeof loadProductsFromAPI!=='function'){grid.innerHTML='<p style="color:#fff;text-align:center;padding:2rem;">Error:funci贸n no disponible. Recarga la p谩gina.</p>';return}try{if(!grid.querySelector('.product-card')){grid.innerHTML='<p style="color:#fff;text-align:center;padding:2rem;">Cargando productos...</p>'}const result=await loadProductsFromAPI(page,PRODUCTS_PER_PAGE,filters);currentPage=result.currentPage;totalPages=result.totalPages;currentFilters=filters;requestAnimationFrame(()=>{renderProducts(result.products);updatePaginationControls();const savedCurrency=localStorage.getItem('selectedCurrency')||'CNY';updateProductPrices(savedCurrency)})}catch(e){grid.innerHTML=`<div style="color:#fff;text-align:center;opacity:.9;padding:40px;"><div style="font-size:22px;margin-bottom:10px;">Error al cargar productos</div><div style="opacity:.7;margin-bottom:20px;">Abr铆 consola(F12)para ver el detalle</div><button onclick="location.reload()" style="padding:10px 20px;background:#0066ff;color:#fff;border:none;border-radius:5px;cursor:pointer;">Recargar p谩gina</button></div>`}}function updatePaginationControls(){const paginationContainer=document.getElementById('paginationContainer');if(!paginationContainer)return;paginationContainer.innerHTML='';if(totalPages<=1)return;const prevBtn=document.createElement('button');prevBtn.className='pagination-btn';prevBtn.textContent=' Anterior';prevBtn.disabled=currentPage===1;prevBtn.addEventListener('click',()=>{if(currentPage>1){loadProductsPage(currentPage-1,currentFilters);window.scrollTo({top:0,behavior:'smooth'})}});paginationContainer.appendChild(prevBtn);const maxVisiblePages=5;let startPage=Math.max(1,currentPage-Math.floor(maxVisiblePages/2));let endPage=Math.min(totalPages,startPage+maxVisiblePages-1);if(endPage-startPage<maxVisiblePages-1){startPage=Math.max(1,endPage-maxVisiblePages+1)}if(startPage>1){const firstBtn=document.createElement('button');firstBtn.className='pagination-btn';firstBtn.textContent='1';firstBtn.addEventListener('click',()=>{loadProductsPage(1,currentFilters);window.scrollTo({top:0,behavior:'smooth'})});paginationContainer.appendChild(firstBtn);if(startPage>2){const ellipsis=document.createElement('span');ellipsis.className='pagination-ellipsis';ellipsis.textContent='...';paginationContainer.appendChild(ellipsis)}}for(let i=startPage;i<=endPage;i++){const pageBtn=document.createElement('button');pageBtn.className=`pagination-btn ${i===currentPage?'active':''}`;pageBtn.textContent=i.toString();pageBtn.addEventListener('click',()=>{loadProductsPage(i,currentFilters);window.scrollTo({top:0,behavior:'smooth'})});paginationContainer.appendChild(pageBtn)}if(endPage<totalPages){if(endPage<totalPages-1){const ellipsis=document.createElement('span');ellipsis.className='pagination-ellipsis';ellipsis.textContent='...';paginationContainer.appendChild(ellipsis)}const lastBtn=document.createElement('button');lastBtn.className='pagination-btn';lastBtn.textContent=totalPages.toString();lastBtn.addEventListener('click',()=>{loadProductsPage(totalPages,currentFilters);window.scrollTo({top:0,behavior:'smooth'})});paginationContainer.appendChild(lastBtn)}const nextBtn=document.createElement('button');nextBtn.className='pagination-btn';nextBtn.textContent='Siguiente ';nextBtn.disabled=currentPage===totalPages;nextBtn.addEventListener('click',()=>{if(currentPage<totalPages){loadProductsPage(currentPage+1,currentFilters);window.scrollTo({top:0,behavior:'smooth'})}});paginationContainer.appendChild(nextBtn)}async function initProductLoading(){const grid=document.querySelector('.products-grid')||document.getElementById('products-grid');const isProductsPage=window.location.pathname.includes('productos.html')||window.location.pathname.endsWith('productos.html')||window.location.href.includes('productos.html')||grid;if(isProductsPage){const urlParams=new URLSearchParams(window.location.search);const pageFromUrl=parseInt(urlParams.get('page'))||1;await loadProductsPage(pageFromUrl,{})}const isHomePage=window.location.pathname.includes('index.html')||window.location.pathname.endsWith('/')||window.location.pathname===''||(!window.location.pathname.includes('.html')&&!isProductsPage);if(isHomePage&&document.querySelector('#productCarousel')){loadFeaturedProducts()}}if(document.readyState==='loading'){document.addEventListener('DOMContentLoaded',initProductLoading)}else{initProductLoading()}function initMeteors(){const meteorsContainer=document.getElementById('meteorsContainer');if(!meteorsContainer)return;const numberOfMeteors=10;for(let i=0;i<numberOfMeteors;i++){const meteor=document.createElement('span');meteor.className='meteor';const left=Math.floor(Math.random()*120);const top=Math.floor(Math.random()*20)-30;const delay=Math.random()*12;const duration=Math.floor(Math.random()*4+3);meteor.style.left=left+'%';meteor.style.top=top+'%';meteor.style.animationDelay=delay+'s';meteor.style.animationDuration=duration+'s';meteorsContainer.appendChild(meteor)}}if(document.readyState==='loading'){document.addEventListener('DOMContentLoaded',initMeteors)}else{initMeteors()}